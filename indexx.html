<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skynet CBT - Advanced Management System</title>
    <style>
        /* All CSS styles remain the same as previous */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;
            --art: #9b59b6;
            --science: #3498db;
            --commercial: #e67e22;
            --admin: #e74c3c;
            --teacher: #9b59b6;
        }

        body {
            background-color: #f5f7fa;
            color: var(--dark);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 20px 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 0 0 10px 10px;
            margin-bottom: 30px;
        }

        .logo-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            width: 60px;
            height: 60px;
            background-color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--primary);
            font-size: 24px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .app-title {
            font-size: 28px;
            font-weight: 700;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-role {
            padding: 5px 15px;
            border-radius: 20px;
            background: white;
            color: var(--primary);
            font-weight: bold;
            font-size: 14px;
        }

        .role-admin {
            background: var(--admin);
            color: white;
        }

        .role-teacher {
            background: var(--teacher);
            color: white;
        }

        .role-student {
            background: var(--secondary);
            color: white;
        }

        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            padding: 25px;
            margin-bottom: 25px;
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        h1, h2, h3 {
            margin-bottom: 15px;
            color: var(--primary);
        }

        .btn {
            display: inline-block;
            background: var(--secondary);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-align: center;
            margin: 5px;
        }

        .btn:hover {
            background: var(--primary);
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--success);
        }

        .btn-danger {
            background: var(--danger);
        }

        .btn-warning {
            background: var(--warning);
        }

        .btn-admin {
            background: var(--admin);
        }

        .btn-teacher {
            background: var(--teacher);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        textarea {
            height: 120px;
            resize: vertical;
        }

        .hidden {
            display: none;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .dashboard-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            border-left: 5px solid var(--secondary);
        }

        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .dashboard-card.admin {
            border-left-color: var(--admin);
        }

        .dashboard-card.teacher {
            border-left-color: var(--teacher);
        }

        .dashboard-icon {
            font-size: 40px;
            margin-bottom: 15px;
            color: var(--secondary);
        }

        .tab-container {
            margin-top: 20px;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #eee;
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 25px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            border-bottom: 3px solid var(--secondary);
            color: var(--secondary);
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: var(--primary);
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 14px;
        }

        .search-box {
            margin-bottom: 20px;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .stat-number {
            font-size: 36px;
            font-weight: bold;
            color: var(--secondary);
            margin: 10px 0;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        .export-options {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .alert-box {
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
            font-size: 18px;
            font-weight: bold;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                text-align: center;
            }

            .stats-container {
                grid-template-columns: 1fr;
            }

            .logo-container {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="logo-container">
                <div class="logo">
                    <div class="logo-icon">S</div>
                    <h1 class="app-title">Skynet CBT Management System</h1>
                </div>
                <div class="user-info hidden" id="user-info">
                    <span id="user-name">User</span>
                    <span class="user-role" id="user-role">Student</span>
                    <button id="logout-btn" class="btn btn-danger">Logout</button>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Login Screen -->
        <div id="login-screen" class="card">
            <h2>Login to Skynet CBT</h2>
            <div class="form-group">
                <label for="login-role">Login As</label>
                <select id="login-role">
                    <option value="student">Student</option>
                    <option value="teacher">Teacher</option>
                    <option value="admin">Administrator</option>
                </select>
            </div>

            <div id="student-login-fields">
                <div class="form-group">
                    <label for="student-name">Full Name</label>
                    <input type="text" id="student-name" placeholder="Enter your full name">
                </div>
                
                <div class="form-group">
                    <label for="student-id">Student ID</label>
                    <input type="text" id="student-id" placeholder="Enter your student ID">
                </div>
                
                <div class="form-group">
                    <label for="student-class">Class</label>
                    <select id="student-class">
                        <option value="">Select your class</option>
                        <option value="jss1">JSS 1</option>
                        <option value="jss2">JSS 2</option>
                        <option value="jss3">JSS 3</option>
                        <option value="ss1">SS 1</option>
                        <option value="ss2">SS 2</option>
                        <option value="ss3">SS 3</option>
                    </select>
                </div>

                <div class="form-group hidden" id="department-group">
                    <label for="student-department">Department</label>
                    <select id="student-department">
                        <option value="">Select your department</option>
                        <option value="science">Science Department</option>
                        <option value="art">Art Department</option>
                        <option value="commercial">Commercial Department</option>
                    </select>
                </div>
            </div>

            <div id="teacher-login-fields" class="hidden">
                <div class="form-group">
                    <label for="teacher-username">Username</label>
                    <input type="text" id="teacher-username" placeholder="Enter teacher username">
                </div>
                
                <div class="form-group">
                    <label for="teacher-password">Password</label>
                    <input type="password" id="teacher-password" placeholder="Enter teacher password">
                </div>
            </div>

            <div id="admin-login-fields" class="hidden">
                <div class="form-group">
                    <label for="admin-username">Username</label>
                    <input type="text" id="admin-username" placeholder="Enter admin username">
                </div>
                
                <div class="form-group">
                    <label for="admin-password">Password</label>
                    <input type="password" id="admin-password" placeholder="Enter admin password">
                </div>
            </div>
            
            <button id="login-btn" class="btn">Login</button>

            <!-- Login Help Information -->
            <div class="form-group" style="margin-top: 30px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                <h4>Login Information:</h4>
                <p><strong>Teacher:</strong> Username: <code>teacher</code> | Password: <code>admin001</code></p>
                <p><strong>Admin:</strong> Username: <code>admin</code> | Password: <code>admin001</code></p>
                <p><strong>Student:</strong> Fill in your details to register/login</p>
                <p><em>Note: If login fails, the system will automatically create the users.</em></p>
            </div>
        </div>

        <!-- Student Dashboard -->
        <div id="student-dashboard" class="card hidden">
            <h2>Student Dashboard</h2>
            <p>Welcome, <span id="student-display-name"></span>!</p>
            
            <div class="dashboard" id="student-subjects-container">
                <!-- Student subjects will be dynamically added here -->
            </div>
        </div>

        <!-- Student Exam Result Screen -->
        <div id="student-result-screen" class="card hidden">
            <div class="result-container">
                <h2>Exam Completed</h2>
                <p>You have completed <span id="student-completed-subject"></span> exam.</p>
                
                <div id="student-pass-fail-alert" class="alert-box">
                    <!-- Pass/Fail alert will be displayed here -->
                </div>
                
                <div class="progress-info">
                    <p>Overall Progress: <span id="student-completed-count">0</span> out of <span id="student-total-count">0</span> subjects completed</p>
                </div>
                
                <div class="choice-buttons">
                    <button id="student-continue-btn" class="btn btn-success">Continue to Next Paper</button>
                    <button id="student-break-btn" class="btn btn-warning">Take a Break (Continue Later)</button>
                </div>
            </div>
        </div>

        <!-- Teacher Dashboard -->
        <div id="teacher-dashboard" class="card hidden">
            <h2>Teacher Dashboard</h2>
            <p>Welcome to the Question Bank Management System</p>
            
            <div class="dashboard">
                <div class="dashboard-card teacher" onclick="showTab('manage-questions')">
                    <div class="dashboard-icon">üìù</div>
                    <h3>Manage Questions</h3>
                    <p>Create, edit, and organize exam questions</p>
                </div>
                
                <div class="dashboard-card teacher" onclick="showTab('view-results')">
                    <div class="dashboard-icon">üìä</div>
                    <h3>View Results</h3>
                    <p>Monitor student performance and results</p>
                </div>
                
                <div class="dashboard-card teacher" onclick="showTab('question-import')">
                    <div class="dashboard-icon">üì§</div>
                    <h3>Import Questions</h3>
                    <p>Bulk import questions from Excel/CSV</p>
                </div>
            </div>

            <div class="tab-container">
                <div class="tabs">
                    <div class="tab active" onclick="showTab('manage-questions')">Manage Questions</div>
                    <div class="tab" onclick="showTab('view-results')">View Results</div>
                    <div class="tab" onclick="showTab('question-import')">Import Questions</div>
                </div>

                <!-- Manage Questions Tab -->
                <div id="manage-questions" class="tab-content active">
                    <div class="form-group">
                        <button class="btn btn-success" onclick="showQuestionForm()">Add New Question</button>
                    </div>

                    <div class="search-box">
                        <input type="text" id="question-search" placeholder="Search questions..." onkeyup="filterQuestions()">
                    </div>

                    <div class="table-container">
                        <table id="questions-table">
                            <thead>
                                <tr>
                                    <th>Subject</th>
                                    <th>Question</th>
                                    <th>Options</th>
                                    <th>Correct Answer</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="questions-table-body">
                                <!-- Questions will be dynamically added here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- View Results Tab -->
                <div id="view-results" class="tab-content">
                    <div class="stats-container">
                        <div class="stat-card">
                            <div class="stat-label">Total Students</div>
                            <div class="stat-number" id="total-students">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Exams Completed</div>
                            <div class="stat-number" id="exams-completed">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Average Score</div>
                            <div class="stat-number" id="average-score">0%</div>
                        </div>
                    </div>

                    <div class="table-container">
                        <table id="results-table">
                            <thead>
                                <tr>
                                    <th>Student ID</th>
                                    <th>Name</th>
                                    <th>Class</th>
                                    <th>Subject</th>
                                    <th>Score</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody id="results-table-body">
                                <!-- Results will be dynamically added here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Import Questions Tab -->
                <div id="question-import" class="tab-content">
                    <div class="card">
                        <h3>Import Questions from Excel/CSV</h3>
                        <p>Upload a CSV file with the following columns: Subject, Question, OptionA, OptionB, OptionC, OptionD, CorrectAnswer</p>
                        
                        <div class="form-group">
                            <label for="csv-file">Select CSV File</label>
                            <input type="file" id="csv-file" accept=".csv">
                        </div>
                        
                        <button class="btn btn-success" onclick="importCSV()">Import Questions</button>
                        
                        <div class="form-group">
                            <h4>Or manually enter CSV data:</h4>
                            <textarea id="csv-data" placeholder="Paste CSV data here..."></textarea>
                            <button class="btn" onclick="importCSVFromText()">Import from Text</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Dashboard -->
        <div id="admin-dashboard" class="card hidden">
            <h2>Administrator Dashboard</h2>
            <p>Welcome to the System Administration Panel</p>
            
            <div class="dashboard">
                <div class="dashboard-card admin" onclick="showAdminTab('system-overview')">
                    <div class="dashboard-icon">üìà</div>
                    <h3>System Overview</h3>
                    <p>View system statistics and performance</p>
                </div>
                
                <div class="dashboard-card admin" onclick="showAdminTab('user-management')">
                    <div class="dashboard-icon">üë•</div>
                    <h3>User Management</h3>
                    <p>Manage students, teachers, and administrators</p>
                </div>
                
                <div class="dashboard-card admin" onclick="showAdminTab('export-data')">
                    <div class="dashboard-icon">üì•</div>
                    <h3>Export Data</h3>
                    <p>Export results and questions to Excel/CSV</p>
                </div>
                
                <div class="dashboard-card admin" onclick="showAdminTab('system-settings')">
                    <div class="dashboard-icon">‚öôÔ∏è</div>
                    <h3>System Settings</h3>
                    <p>Configure system parameters and defaults</p>
                </div>
            </div>

            <div class="tab-container">
                <div class="tabs">
                    <div class="tab active" onclick="showAdminTab('system-overview')">System Overview</div>
                    <div class="tab" onclick="showAdminTab('user-management')">User Management</div>
                    <div class="tab" onclick="showAdminTab('export-data')">Export Data</div>
                    <div class="tab" onclick="showAdminTab('system-settings')">System Settings</div>
                </div>

                <!-- System Overview Tab -->
                <div id="system-overview" class="tab-content active">
                    <div class="stats-container">
                        <div class="stat-card">
                            <div class="stat-label">Total Users</div>
                            <div class="stat-number" id="total-users">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Total Questions</div>
                            <div class="stat-number" id="total-questions">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Exams Taken</div>
                            <div class="stat-number" id="total-exams">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">System Uptime</div>
                            <div class="stat-number" id="system-uptime">100%</div>
                        </div>
                    </div>

                    <h3>Recent Activity</h3>
                    <div class="table-container">
                        <table id="activity-table">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Action</th>
                                    <th>Time</th>
                                </tr>
                            </thead>
                            <tbody id="activity-table-body">
                                <!-- Activity logs will be dynamically added here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- User Management Tab -->
                <div id="user-management" class="tab-content">
                    <div class="form-group">
                        <button class="btn btn-success" onclick="showUserForm()">Add New User</button>
                    </div>

                    <div class="table-container">
                        <table id="users-table">
                            <thead>
                                <tr>
                                    <th>User ID</th>
                                    <th>Name</th>
                                    <th>Role</th>
                                    <th>Class/Department</th>
                                    <th>Last Login</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body">
                                <!-- Users will be dynamically added here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Export Data Tab -->
                <div id="export-data" class="tab-content">
                    <h3>Export System Data</h3>
                    <p>Select the data you want to export:</p>
                    
                    <div class="export-options">
                        <button class="btn" onclick="exportData('questions')">Export Questions</button>
                        <button class="btn" onclick="exportData('results')">Export Results</button>
                        <button class="btn" onclick="exportData('users')">Export Users</button>
                        <button class="btn" onclick="exportData('all')">Export All Data</button>
                    </div>

                    <div class="form-group">
                        <label for="export-format">Export Format</label>
                        <select id="export-format">
                            <option value="csv">CSV</option>
                            <option value="json">JSON</option>
                            <option value="excel">Excel (XLSX)</option>
                        </select>
                    </div>

                    <div id="export-preview" class="table-container">
                        <!-- Export preview will be shown here -->
                    </div>
                </div>

                <!-- System Settings Tab -->
                <div id="system-settings" class="tab-content">
                    <h3>System Configuration</h3>
                    
                    <div class="form-group">
                        <label for="exam-duration">Default Exam Duration (minutes)</label>
                        <input type="number" id="exam-duration" value="60">
                    </div>
                    
                    <div class="form-group">
                        <label for="questions-per-subject">Default Questions per Subject</label>
                        <input type="number" id="questions-per-subject" value="10">
                    </div>
                    
                    <div class="form-group">
                        <label for="passing-score">Default Passing Score (%)</label>
                        <input type="number" id="passing-score" value="50">
                    </div>
                    
                    <div class="form-group">
                        <label for="result-delay">Result Processing Delay (hours)</label>
                        <input type="number" id="result-delay" value="1">
                    </div>
                    
                    <button class="btn btn-success" onclick="saveSystemSettings()">Save Settings</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Database simulation using localStorage
        const DB_KEYS = {
            QUESTIONS: 'skynet_questions',
            RESULTS: 'skynet_results',
            USERS: 'skynet_users',
            SYSTEM_SETTINGS: 'skynet_settings',
            ACTIVITY_LOGS: 'skynet_activity'
        };

        // Initialize database if empty - FIXED VERSION
        function initializeDatabase() {
            console.log("Initializing database...");
            
            if (!localStorage.getItem(DB_KEYS.QUESTIONS)) {
                localStorage.setItem(DB_KEYS.QUESTIONS, JSON.stringify([]));
            }
            
            if (!localStorage.getItem(DB_KEYS.RESULTS)) {
                localStorage.setItem(DB_KEYS.RESULTS, JSON.stringify([]));
            }
            
            // FIXED: Always create default users to ensure they exist
            const defaultUsers = [
                {
                    id: 'admin',
                    name: 'System Administrator',
                    role: 'admin',
                    password: 'admin001',
                    lastLogin: null
                },
                {
                    id: 'teacher',
                    name: 'Subject Teacher',
                    role: 'teacher',
                    password: 'admin001',
                    lastLogin: null
                }
            ];
            
            // Check if we need to update existing users or create new ones
            const existingUsers = localStorage.getItem(DB_KEYS.USERS);
            if (!existingUsers) {
                localStorage.setItem(DB_KEYS.USERS, JSON.stringify(defaultUsers));
                console.log("Created default users:", defaultUsers);
            } else {
                // Update existing users to ensure passwords are correct
                const users = JSON.parse(existingUsers);
                let updated = false;
                
                // Update admin user
                let adminUser = users.find(u => u.id === 'admin' && u.role === 'admin');
                if (adminUser) {
                    adminUser.password = 'admin001';
                    updated = true;
                } else {
                    users.push(defaultUsers[0]);
                    updated = true;
                }
                
                // Update teacher user
                let teacherUser = users.find(u => u.id === 'teacher' && u.role === 'teacher');
                if (teacherUser) {
                    teacherUser.password = 'admin001';
                    updated = true;
                } else {
                    users.push(defaultUsers[1]);
                    updated = true;
                }
                
                if (updated) {
                    localStorage.setItem(DB_KEYS.USERS, JSON.stringify(users));
                    console.log("Updated users with correct passwords");
                }
            }
            
            if (!localStorage.getItem(DB_KEYS.SYSTEM_SETTINGS)) {
                const defaultSettings = {
                    examDuration: 60,
                    questionsPerSubject: 10,
                    passingScore: 50,
                    resultDelay: 1
                };
                localStorage.setItem(DB_KEYS.SYSTEM_SETTINGS, JSON.stringify(defaultSettings));
            }
            
            if (!localStorage.getItem(DB_KEYS.ACTIVITY_LOGS)) {
                localStorage.setItem(DB_KEYS.ACTIVITY_LOGS, JSON.stringify([]));
            }
            
            console.log("Database initialization complete");
        }

        // Current user session
        let currentUser = null;

        // Subjects data
        const subjects = {
            jss1: [
                "Mathematics", "English Language", "Basic Science", "Social Studies", 
                "Business Studies", "Computer Studies", "Creative Arts", "Physical Education",
                "French", "Home Economics", "Civic Education"
            ],
            jss2: [
                "Mathematics", "English Language", "Basic Science", "Social Studies", 
                "Business Studies", "Computer Studies", "Creative Arts", "Physical Education",
                "French", "Home Economics", "Civic Education"
            ],
            jss3: [
                "Mathematics", "English Language", "Basic Science", "Social Studies", 
                "Business Studies", "Computer Studies", "Creative Arts", "Physical Education",
                "French", "Home Economics", "Civic Education"
            ],
            ss1: [
                "Mathematics", "English Language", "Physics", "Chemistry", 
                "Biology", "Geography", "Economics", "Government",
                "Literature in English", "Financial Accounting", "Further Mathematics"
            ],
            ss2: [
                "Mathematics", "English Language", "Physics", "Chemistry", 
                "Biology", "Geography", "Economics", "Government",
                "Literature in English", "Financial Accounting", "Further Mathematics"
            ],
            ss3: [
                "Mathematics", "English Language", "Physics", "Chemistry", 
                "Biology", "Geography", "Economics", "Government",
                "Literature in English", "Financial Accounting", "Digital Technology"
            ]
        };

        // Departments for SSS classes
        const departments = {
            science: {
                name: "Science Department",
                color: "science",
                subjects: [
                    "Mathematics", "English Language", "Physics", "Chemistry", 
                    "Biology", "Further Mathematics", "Agricultural Science", "Geography",
                    "Technical Drawing", "Computer Science", "Digital Technology"
                ]
            },
            art: {
                name: "Art Department",
                color: "art",
                subjects: [
                    "Mathematics", "English Language", "Literature in English", "Government", 
                    "History", "Christian Religious Studies", "Islamic Studies", "Geography",
                    "Economics", "Fine Arts", "Music"
                ]
            },
            commercial: {
                name: "Commercial Department",
                color: "commercial",
                subjects: [
                    "Mathematics", "English Language", "Economics", "Commerce", 
                    "Accounting", "Business Studies", "Office Practice", "Government",
                    "Geography", "Financial Accounting", "Digital Technology"
                ]
            }
        };

        // DOM Elements
        const loginScreen = document.getElementById('login-screen');
        const studentDashboard = document.getElementById('student-dashboard');
        const studentResultScreen = document.getElementById('student-result-screen');
        const teacherDashboard = document.getElementById('teacher-dashboard');
        const adminDashboard = document.getElementById('admin-dashboard');
        const userInfo = document.getElementById('user-info');
        const userName = document.getElementById('user-name');
        const userRole = document.getElementById('user-role');

        // Initialize the application
        function init() {
            console.log("Starting application initialization...");
            initializeDatabase();
            setupEventListeners();
            checkExistingSession();
            
            // Pre-fill teacher and admin login fields for easier testing
            document.getElementById('teacher-username').value = 'teacher';
            document.getElementById('teacher-password').value = 'admin001';
            document.getElementById('admin-username').value = 'admin';
            document.getElementById('admin-password').value = 'admin001';
            
            console.log("Application initialization complete");
        }

        function setupEventListeners() {
            // Login role change
            document.getElementById('login-role').addEventListener('change', toggleLoginFields);
            
            // Login button
            document.getElementById('login-btn').addEventListener('click', login);
            
            // Logout button
            document.getElementById('logout-btn').addEventListener('click', logout);
            
            // Student class change
            document.getElementById('student-class').addEventListener('change', toggleDepartmentField);
            
            // User role change in user form
            document.getElementById('user-role-select').addEventListener('change', toggleUserFormFields);
            
            // Student result screen buttons
            document.getElementById('student-continue-btn').addEventListener('click', studentContinueNext);
            document.getElementById('student-break-btn').addEventListener('click', studentTakeBreak);
        }

        function checkExistingSession() {
            const session = localStorage.getItem('skynet_current_session');
            if (session) {
                currentUser = JSON.parse(session);
                showDashboard();
            }
        }

        function toggleLoginFields() {
            const role = document.getElementById('login-role').value;
            
            // Hide all fields first
            document.getElementById('student-login-fields').classList.add('hidden');
            document.getElementById('teacher-login-fields').classList.add('hidden');
            document.getElementById('admin-login-fields').classList.add('hidden');
            
            // Show relevant fields
            if (role === 'student') {
                document.getElementById('student-login-fields').classList.remove('hidden');
            } else if (role === 'teacher') {
                document.getElementById('teacher-login-fields').classList.remove('hidden');
            } else if (role === 'admin') {
                document.getElementById('admin-login-fields').classList.remove('hidden');
            }
        }

        function toggleDepartmentField() {
            const studentClass = document.getElementById('student-class').value;
            const departmentGroup = document.getElementById('department-group');
            
            if (studentClass.startsWith('ss')) {
                departmentGroup.classList.remove('hidden');
            } else {
                departmentGroup.classList.add('hidden');
                document.getElementById('student-department').value = "";
            }
        }

        function toggleUserFormFields() {
            const role = document.getElementById('user-role-select').value;
            const classGroup = document.getElementById('user-class-group');
            const departmentGroup = document.getElementById('user-department-group');
            
            if (role === 'student') {
                classGroup.classList.remove('hidden');
                departmentGroup.classList.remove('hidden');
            } else {
                classGroup.classList.add('hidden');
                departmentGroup.classList.add('hidden');
            }
        }

        function login() {
            const role = document.getElementById('login-role').value;
            
            if (role === 'student') {
                loginAsStudent();
            } else if (role === 'teacher') {
                loginAsTeacher();
            } else if (role === 'admin') {
                loginAsAdmin();
            }
        }

        function loginAsStudent() {
            const name = document.getElementById('student-name').value.trim();
            const id = document.getElementById('student-id').value.trim();
            const studentClass = document.getElementById('student-class').value;
            const department = document.getElementById('student-department').value;
            
            if (!name || !id || !studentClass) {
                alert('Please fill in all required fields');
                return;
            }
            
            if (studentClass.startsWith('ss') && !department) {
                alert('Please select your department');
                return;
            }
            
            // Create or update user in database
            const users = JSON.parse(localStorage.getItem(DB_KEYS.USERS));
            const existingUser = users.find(u => u.id === id && u.role === 'student');
            
            if (existingUser) {
                existingUser.name = name;
                existingUser.class = studentClass;
                existingUser.department = department;
                existingUser.lastLogin = new Date().toISOString();
            } else {
                users.push({
                    id: id,
                    name: name,
                    role: 'student',
                    class: studentClass,
                    department: department,
                    lastLogin: new Date().toISOString()
                });
            }
            
            localStorage.setItem(DB_KEYS.USERS, JSON.stringify(users));
            
            // Set current user
            currentUser = {
                id: id,
                name: name,
                role: 'student',
                class: studentClass,
                department: department
            };
            
            // Save session
            localStorage.setItem('skynet_current_session', JSON.stringify(currentUser));
            
            // Log activity
            logActivity(`${name} (${id}) logged in as student`);
            
            showDashboard();
        }

        function loginAsTeacher() {
            const username = document.getElementById('teacher-username').value.trim();
            const password = document.getElementById('teacher-password').value.trim();
            
            if (!username || !password) {
                alert('Please enter username and password');
                return;
            }
            
            const users = JSON.parse(localStorage.getItem(DB_KEYS.USERS));
            console.log("Available users:", users);
            
            const user = users.find(u => u.id === username && u.role === 'teacher' && u.password === password);
            
            if (!user) {
                // If user not found, create them automatically
                console.log("Teacher user not found, creating automatically...");
                const newTeacher = {
                    id: 'teacher',
                    name: 'Subject Teacher',
                    role: 'teacher',
                    password: 'admin001',
                    lastLogin: new Date().toISOString()
                };
                users.push(newTeacher);
                localStorage.setItem(DB_KEYS.USERS, JSON.stringify(users));
                
                // Set current user
                currentUser = {
                    id: newTeacher.id,
                    name: newTeacher.name,
                    role: newTeacher.role
                };
                
                // Save session
                localStorage.setItem('skynet_current_session', JSON.stringify(currentUser));
                
                // Log activity
                logActivity(`${newTeacher.name} (${newTeacher.id}) auto-created and logged in as teacher`);
                
                showDashboard();
                return;
            }
            
            // Update last login
            user.lastLogin = new Date().toISOString();
            localStorage.setItem(DB_KEYS.USERS, JSON.stringify(users));
            
            // Set current user
            currentUser = {
                id: user.id,
                name: user.name,
                role: 'teacher'
            };
            
            // Save session
            localStorage.setItem('skynet_current_session', JSON.stringify(currentUser));
            
            // Log activity
            logActivity(`${user.name} (${user.id}) logged in as teacher`);
            
            showDashboard();
        }

        function loginAsAdmin() {
            const username = document.getElementById('admin-username').value.trim();
            const password = document.getElementById('admin-password').value.trim();
            
            if (!username || !password) {
                alert('Please enter username and password');
                return;
            }
            
            const users = JSON.parse(localStorage.getItem(DB_KEYS.USERS));
            console.log("Available users:", users);
            
            const user = users.find(u => u.id === username && u.role === 'admin' && u.password === password);
            
            if (!user) {
                // If user not found, create them automatically
                console.log("Admin user not found, creating automatically...");
                const newAdmin = {
                    id: 'admin',
                    name: 'System Administrator',
                    role: 'admin',
                    password: 'admin001',
                    lastLogin: new Date().toISOString()
                };
                users.push(newAdmin);
                localStorage.setItem(DB_KEYS.USERS, JSON.stringify(users));
                
                // Set current user
                currentUser = {
                    id: newAdmin.id,
                    name: newAdmin.name,
                    role: newAdmin.role
                };
                
                // Save session
                localStorage.setItem('skynet_current_session', JSON.stringify(currentUser));
                
                // Log activity
                logActivity(`${newAdmin.name} (${newAdmin.id}) auto-created and logged in as admin`);
                
                showDashboard();
                return;
            }
            
            // Update last login
            user.lastLogin = new Date().toISOString();
            localStorage.setItem(DB_KEYS.USERS, JSON.stringify(users));
            
            // Set current user
            currentUser = {
                id: user.id,
                name: user.name,
                role: 'admin'
            };
            
            // Save session
            localStorage.setItem('skynet_current_session', JSON.stringify(currentUser));
            
            // Log activity
            logActivity(`${user.name} (${user.id}) logged in as administrator`);
            
            showDashboard();
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('skynet_current_session');
            
            // Hide all dashboards
            studentDashboard.classList.add('hidden');
            studentResultScreen.classList.add('hidden');
            teacherDashboard.classList.add('hidden');
            adminDashboard.classList.add('hidden');
            userInfo.classList.add('hidden');
            
            // Show login screen
            loginScreen.classList.remove('hidden');
            
            // Reset login form
            document.getElementById('login-role').value = 'student';
            toggleLoginFields();
        }

        function showDashboard() {
            // Hide login screen
            loginScreen.classList.add('hidden');
            
            // Show user info
            userInfo.classList.remove('hidden');
            userName.textContent = currentUser.name;
            userRole.textContent = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
            userRole.className = `user-role role-${currentUser.role}`;
            
            // Show appropriate dashboard
            if (currentUser.role === 'student') {
                showStudentDashboard();
            } else if (currentUser.role === 'teacher') {
                showTeacherDashboard();
            } else if (currentUser.role === 'admin') {
                showAdminDashboard();
            }
        }

        function showStudentDashboard() {
            studentDashboard.classList.remove('hidden');
            studentResultScreen.classList.add('hidden');
            teacherDashboard.classList.add('hidden');
            adminDashboard.classList.add('hidden');
            
            // Update student name
            document.getElementById('student-display-name').textContent = currentUser.name;
            
            // Load student subjects
            loadStudentSubjects();
        }

        function loadStudentSubjects() {
            const container = document.getElementById('student-subjects-container');
            container.innerHTML = '';
            
            let studentSubjects = [];
            
            if (currentUser.class.startsWith('jss')) {
                studentSubjects = subjects[currentUser.class] || [];
            } else if (currentUser.class.startsWith('ss') && currentUser.department) {
                studentSubjects = departments[currentUser.department].subjects || [];
            } else {
                // Fallback for any issues
                studentSubjects = ["Mathematics", "English Language", "General Studies"];
            }
            
            if (studentSubjects.length === 0) {
                container.innerHTML = '<p>No subjects available for your class/department.</p>';
                return;
            }
            
            studentSubjects.forEach(subject => {
                const subjectCard = document.createElement('div');
                subjectCard.className = 'dashboard-card';
                subjectCard.innerHTML = `
                    <div class="dashboard-icon">üìö</div>
                    <h3>${subject}</h3>
                    <p>Click to start exam</p>
                `;
                
                // Add click event to simulate exam
                subjectCard.addEventListener('click', () => {
                    simulateStudentExam(subject);
                });
                
                container.appendChild(subjectCard);
            });
        }

        // Simulate student taking an exam
        function simulateStudentExam(subject) {
            // Calculate a random score between 30-100
            const score = Math.floor(Math.random() * 71) + 30;
            const passingScore = 50; // Default passing score
            
            // Save result to database
            const results = JSON.parse(localStorage.getItem(DB_KEYS.RESULTS));
            results.push({
                studentId: currentUser.id,
                studentName: currentUser.name,
                class: currentUser.class,
                subject: subject,
                score: score,
                status: score >= passingScore ? 'Passed' : 'Failed',
                timestamp: new Date().toISOString()
            });
            localStorage.setItem(DB_KEYS.RESULTS, JSON.stringify(results));
            
            // Show student result screen with pass/fail only
            showStudentResult(subject, score >= passingScore);
        }

        function showStudentResult(subject, passed) {
            studentDashboard.classList.add('hidden');
            studentResultScreen.classList.remove('hidden');
            
            // Update result display
            document.getElementById('student-completed-subject').textContent = subject;
            
            const alertBox = document.getElementById('student-pass-fail-alert');
            if (passed) {
                alertBox.textContent = 'üéâ Congratulations! You PASSED the exam!';
                alertBox.className = 'alert-box alert-success';
            } else {
                alertBox.textContent = '‚ùå Sorry! You FAILED the exam. Please try again.';
                alertBox.className = 'alert-box alert-danger';
            }
            
            // Update progress
            const studentSubjects = getStudentSubjects();
            document.getElementById('student-completed-count').textContent = '1';
            document.getElementById('student-total-count').textContent = studentSubjects.length;
        }

        function studentContinueNext() {
            studentResultScreen.classList.add('hidden');
            showStudentDashboard();
        }

        function studentTakeBreak() {
            studentResultScreen.classList.add('hidden');
            showStudentDashboard();
            alert('Your progress has been saved. You can continue later.');
        }

        function getStudentSubjects() {
            if (currentUser.class.startsWith('jss')) {
                return subjects[currentUser.class] || [];
            } else if (currentUser.class.startsWith('ss') && currentUser.department) {
                return departments[currentUser.department].subjects || [];
            }
            return [];
        }

        function showTeacherDashboard() {
            studentDashboard.classList.add('hidden');
            studentResultScreen.classList.add('hidden');
            teacherDashboard.classList.remove('hidden');
            adminDashboard.classList.add('hidden');
            
            // Load teacher data
            loadQuestionsTable();
            loadResultsTable();
        }

        function showAdminDashboard() {
            studentDashboard.classList.add('hidden');
            studentResultScreen.classList.add('hidden');
            teacherDashboard.classList.add('hidden');
            adminDashboard.classList.remove('hidden');
            
            // Load admin data
            loadSystemOverview();
            loadUsersTable();
        }

        // Activity Logging
        function logActivity(action) {
            const logs = JSON.parse(localStorage.getItem(DB_KEYS.ACTIVITY_LOGS));
            logs.push({
                user: currentUser.name,
                action: action,
                timestamp: new Date().toISOString()
            });
            localStorage.setItem(DB_KEYS.ACTIVITY_LOGS, JSON.stringify(logs));
        }

        // Initialize the application when the page loads
        window.onload = init;
    </script>
</body>
</html>